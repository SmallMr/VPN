parsers: # array æ›´æ–°äº 2023 https://docs.cfw.lbyczf.com/contents/parser.html
# - reg: ^.*$ åŒ¹é…æ‰€æœ‰è®¢é˜…ï¼Œæˆ–ç”¨ä¸‹é¢ - url: æŒ‡å®šè®¢é˜…ï¼ŒäºŒé€‰å…¶ä¸€
  - reg: ^.*$
    yaml:
      mix-rule-providers:
        reject:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt"
            path: ./ruleset/reject.yaml
            interval: 86400
        icloud:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt"
            path: ./ruleset/icloud.yaml
            interval: 86400
        apple:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt"
            path: ./ruleset/apple.yaml
            interval: 86400
        google:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt"
            path: ./ruleset/google.yaml
            interval: 86400
        proxy:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt"
            path: ./ruleset/proxy.yaml
            interval: 86400
        direct:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt"
            path: ./ruleset/direct.yaml
            interval: 86400
        private:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt"
            path: ./ruleset/private.yaml
            interval: 86400
        gfw:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt"
            path: ./ruleset/gfw.yaml
            interval: 86400
        tld-not-cn:
            type: http
            behavior: domain
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt"
            path: ./ruleset/tld-not-cn.yaml
            interval: 86400
        telegramcidr:
            type: http
            behavior: ipcidr
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt"
            path: ./ruleset/telegramcidr.yaml
            interval: 86400
        cncidr:
            type: http
            behavior: ipcidr
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt"
            path: ./ruleset/cncidr.yaml
            interval: 86400
        lancidr:
            type: http
            behavior: ipcidr
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt"
            path: ./ruleset/lancidr.yaml
            interval: 86400
        applications:
            type: http
            behavior: classical
            url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt"
            path: ./ruleset/applications.yaml
            interval: 86400
      prepend-rules:
        # rules æœ€å‰é¢å¢åŠ è‡ªå®šä¹‰ä¸ªäººçš„è§„åˆ™
        - DOMAIN, translate.googleapis.com, âœˆï¸ PROXY
        # ç™½åå•æ¨¡å¼ 
        - RULE-SET,applications,DIRECT
        - DOMAIN,clash.razord.top,DIRECT
        - DOMAIN,yacd.haishan.me,DIRECT
        - RULE-SET,private,DIRECT
        - RULE-SET,reject,REJECT
        - RULE-SET,icloud,DIRECT
        - RULE-SET,apple,DIRECT
        #- RULE-SET,google,DIRECT   # [æ…ç”¨]Google åœ¨ä¸­å›½å¤§é™†å¯ç›´è¿çš„åŸŸååˆ—è¡¨ google.txt
        - RULE-SET,proxy,âœˆï¸ PROXY
        - RULE-SET,direct,DIRECT
        - RULE-SET,lancidr,DIRECT
        - RULE-SET,cncidr,DIRECT
        - RULE-SET,telegramcidr,âœˆï¸ PROXY
        - GEOIP,LAN,DIRECT
        - GEOIP,CN,DIRECT
        - MATCH,âœˆï¸ PROXY
    code: |
      module.exports.parse = (raw, { yaml }) => {
        const rawObj = yaml.parse(raw)
      
        // æ¸…ç©º rules å’Œ proxy-groups
        rawObj.rules = []
        rawObj['proxy-groups'] = []
      
        // æå–è®¢é˜…é“¾æ¥ä¸­çš„èŠ‚ç‚¹åˆ—è¡¨
        const proxies = rawObj.proxies.map(proxy => proxy.name)
      
        // è¿‡æ»¤æ‰å¸¦æœ‰ç‰¹å®šå­—æ ·çš„èŠ‚ç‚¹
        const filteredProxiesPROXY = proxies.filter(proxy => !proxy.includes('50') && !proxy.includes('è´¦å·') && !proxy.includes('è´¦å·'))
        const filteredProxiesOpenAI = proxies.filter(proxy => !proxy.includes('50') && !proxy.includes('è´¦å·') && !proxy.includes('è´¦å·') && !proxy.includes('HK'))
        const filteredProxiesAutoSelect = proxies.filter(proxy => !proxy.includes('50') && !proxy.includes('20') && !proxy.includes('è´¦å·') && !proxy.includes('è´¦å·'))
        const filteredProxiesHighRate = proxies.filter(proxy => proxy.includes('50') || proxy.includes('20'))
      
        // æ·»åŠ åä¸º "PROXY" çš„é¡¹åˆ° proxy-groupsï¼Œè¿‡æ»¤æ‰å¸¦æœ‰ç‰¹å®šå­—æ ·çš„èŠ‚ç‚¹
        rawObj['proxy-groups'].push({
          name: 'âœˆï¸ PROXY',
          type: 'select',
          proxies: ['DIRECT', 'ğŸŠ OpenAI', 'â™»ï¸ è‡ªåŠ¨é€‰æ‹©', 'ğŸ€ é«˜çš„å€ç‡', ...filteredProxiesPROXY.filter(proxy => proxies.includes(proxy))]
        })
      
        // æ·»åŠ åä¸º "ğŸŠ OpenAI" çš„é¡¹åˆ° proxy-groupsï¼Œè¿‡æ»¤æ‰å¸¦æœ‰ç‰¹å®šå­—æ ·çš„èŠ‚ç‚¹
        rawObj['proxy-groups'].push({
          name: 'ğŸŠ OpenAI',
          type: 'select',
          proxies: filteredProxiesOpenAI
        })
      
        // æ·»åŠ åä¸º "â™»ï¸ è‡ªåŠ¨é€‰æ‹©" çš„é¡¹åˆ° proxy-groupsï¼Œè¿‡æ»¤æ‰å¸¦æœ‰ç‰¹å®šå­—æ ·çš„èŠ‚ç‚¹
        rawObj['proxy-groups'].push({
          name: 'â™»ï¸ è‡ªåŠ¨é€‰æ‹©',
          type: 'url-test',
          url: 'http://www.gstatic.com/generate_204',
          interval: 300,
          proxies: filteredProxiesAutoSelect
        })
        
        // æ·»åŠ åä¸º "ğŸ€ é«˜çš„å€ç‡" çš„é¡¹åˆ° proxy-groupsï¼Œè¿‡æ»¤ä¸ºä»…ä½¿ç”¨ 50ï¼Œ20 è¿™ç§é«˜å€ç‡çš„å¸¦æœ‰ç‰¹å®šå­—æ ·çš„èŠ‚ç‚¹
        rawObj['proxy-groups'].push({
          name: 'ğŸ€ é«˜çš„å€ç‡',
          type: 'select',
          proxies: filteredProxiesHighRate
        })
      
        return yaml.stringify(rawObj)
      }